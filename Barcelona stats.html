<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>EA FC 26 ¬∑ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ë–∞—Ä—Å–µ–ª–æ–Ω—ã</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --barca-blue: #004d98;
      --barca-claret: #a50044;
      --barca-gold: #fdb913;
      --barca-dark: #0b1421;
      --barca-bg: #020814;
      --card-bg: rgba(4, 17, 40, 0.95);
      --text-main: #f5f5f5;
      --text-muted: #a0aec0;
      --border-soft: rgba(255, 255, 255, 0.08);
      --input-bg: rgba(3, 22, 46, 0.95);
      --error-color: #ff6b6b;
      --success-color: #22c55e;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1a3358 0, var(--barca-bg) 45%, #01030a 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    header {
      background: linear-gradient(90deg, var(--barca-claret), var(--barca-blue));
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-symbol {
      width: 40px;
      height: 40px;
      border-radius: 14px;
      background:
        linear-gradient(135deg, var(--barca-gold), #ffeaa7);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.6);
      position: relative;
      overflow: hidden;
    }

    .logo-symbol::before,
    .logo-symbol::after {
      content: "";
      position: absolute;
      inset: 6px;
      border-radius: 10px;
      border: 2px solid rgba(0, 0, 0, 0.7);
    }

    .logo-title-main {
      font-weight: 800;
      font-size: 1.25rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .logo-title-sub {
      font-size: 0.8rem;
      opacity: 0.85;
    }

    .header-badge {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      background: rgba(0, 0, 0, 0.2);
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    main {
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto 40px;
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 2.1fr);
      gap: 20px;
    }

    @media (max-width: 960px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      padding: 18px 18px 16px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(20px);
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .card-pill {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.85;
    }

    .card-description {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .section-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 12px;
    }

    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .form-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }

    label {
      color: var(--text-muted);
      font-size: 0.76rem;
    }

    input[type="text"],
    input[type="number"],
    select {
      background: var(--input-bg);
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 8px 12px;
      color: var(--text-main);
      font-size: 0.82rem;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      border-color: var(--barca-gold);
      box-shadow: 0 0 0 1px rgba(253, 185, 19, 0.5);
      background: rgba(4, 30, 72, 0.95);
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, var(--barca-gold), #ffe27a);
      color: #3b2800;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.7);
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
      white-space: nowrap;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.8);
      filter: brightness(1.05);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 5px 14px rgba(0, 0, 0, 0.75);
      filter: brightness(0.96);
    }

    .button-secondary {
      background: transparent;
      border: 1px solid var(--border-soft);
      color: var(--text-main);
      box-shadow: none;
    }

    .button-secondary:hover {
      border-color: rgba(255, 255, 255, 0.4);
      background: rgba(13, 30, 63, 0.9);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.6);
    }

    .players-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      max-height: 80px;
      overflow-y: auto;
    }

    .player-chip {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      padding: 3px 9px;
      font-size: 0.75rem;
      background: rgba(0, 0, 0, 0.32);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .player-initials {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--barca-blue), var(--barca-claret));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.65rem;
      font-weight: 700;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(0, 0, 0, 0.35);
      color: var(--text-muted);
    }

    .status {
      margin-top: 6px;
      font-size: 0.78rem;
    }

    .status.success {
      color: var(--success-color);
    }

    .status.error {
      color: var(--error-color);
    }

    .table-wrapper {
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      margin-top: 8px;
      background: rgba(2, 11, 26, 0.95);
      overflow-x: auto;
      overflow-y: hidden;
    }

    table {
      width: 100%;
      min-width: 900px;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    thead {
      background: linear-gradient(90deg, rgba(165, 0, 68, 0.9), rgba(0, 77, 152, 0.9));
    }

    th,
    td {
      padding: 6px 8px;
      text-align: right;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    th:first-child,
    td:first-child {
      text-align: left;
    }

    th {
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      position: relative;
      white-space: nowrap;
    }

    th.sortable::after {
      content: "‚Üï";
      font-size: 0.7rem;
      opacity: 0.6;
      margin-left: 4px;
    }

    th.sort-asc::after {
      content: "‚Üë";
    }

    th.sort-desc::after {
      content: "‚Üì";
    }

    tbody tr:nth-child(even) {
      background: rgba(4, 16, 35, 0.92);
    }

    tbody tr:nth-child(odd) {
      background: rgba(5, 22, 48, 0.92);
    }

    tbody tr:hover {
      background: rgba(12, 39, 82, 0.96);
    }

    .empty-state {
      padding: 10px;
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .filters-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
      font-size: 0.78rem;
      flex-wrap: wrap;
    }

    .chart-container {
      position: relative;
      height: 260px;
      margin-top: 8px;
    }

    #chartMessage {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .pill-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 0.7rem;
    }

    .pill {
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(0, 0, 0, 0.35);
    }

    .soft-divider {
      height: 1px;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.24), transparent 65%);
      opacity: 0.5;
      margin: 6px 0;
    }

    /* –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ */
    td.metric-low {
      color: #9ca3af;
      opacity: 0.9;
    }

    td.metric-mid {
      color: #facc15;
      font-weight: 500;
    }

    td.metric-high {
      color: #4ade80;
      font-weight: 600;
      text-shadow: 0 0 4px rgba(34, 197, 94, 0.3);
    }

    .file-input {
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    /* --- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–µ–∑–æ–Ω–∞ –∏ –ø–æ–ª–µ --- */
    .season-insights {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 14px;
    }

    @media (max-width: 960px) {
      .season-insights {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .awards-list {
      font-size: 0.8rem;
      display: grid;
      gap: 4px;
    }

    .award-item span:first-child {
      color: var(--text-muted);
      margin-right: 4px;
    }

    .profiles-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      font-size: 0.75rem;
      margin-top: 6px;
    }

    .profile-block {
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      padding: 6px 8px;
      background: rgba(4, 16, 40, 0.9);
    }

    .profile-title {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .profile-list {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .profile-tag {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      font-size: 0.7rem;
    }

    .profile-tag.alien {
      border-color: #22c55e;
      color: #bbf7d0;
    }

    .profile-tag.sniper {
      border-color: #38bdf8;
      color: #e0f2fe;
    }

    .profile-tag.horse {
      border-color: #f97316;
      color: #ffedd5;
    }

    .profile-tag.rotation {
      border-color: #6b7280;
      color: #e5e7eb;
    }

    .pitch-wrapper {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .pitch {
      position: relative;
      border-radius: 18px;
      border: 1px solid rgba(34, 197, 94, 0.5);
      background: radial-gradient(circle at top, #15803d 0, #166534 45%, #14532d 100%);
      padding: 10px 8px;
      height: 230px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      overflow: hidden;
    }

    .pitch::before,
    .pitch::after {
      content: "";
      position: absolute;
      inset: 10px 30%;
      border-radius: 80px;
      border: 1px solid rgba(226, 232, 240, 0.2);
    }

    .pitch::after {
      inset: 40% 40%;
      border-radius: 999px;
    }

    .pitch-line {
      position: relative;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 1;
    }

    .pitch-player {
      min-width: 68px;
      max-width: 90px;
      text-align: center;
      font-size: 0.7rem;
      padding: 3px 5px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(248, 250, 252, 0.6);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pitch-player span {
      display: block;
    }

    .pitch-player-role {
      font-size: 0.6rem;
      color: #e5e7eb;
      opacity: 0.85;
    }

    .pitch-caption {
      font-size: 0.75rem;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
<header>
  <div class="logo">
    <div class="logo-symbol"></div>
    <div>
      <div class="logo-title-main">BAR√áA STATS HUB</div>
      <div class="logo-title-sub">EA FC 26 ‚Äî –∫–ª—É–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
    </div>
  </div>
  <div class="header-badge">
    <span>üîí</span>
    <span>–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage) + —ç–∫—Å–ø–æ—Ä—Ç –≤ —Ñ–∞–π–ª</span>
  </div>
</header>

<main>
  <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
  <section class="section-grid">
    <!-- –ò–≥—Ä–æ–∫–∏ -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          üë• –ò–≥—Ä–æ–∫–∏
          <span class="card-pill">–ë–∞–∑–∞ –∏–≥—Ä–æ–∫–æ–≤</span>
        </div>
      </div>
      <p class="card-description">
        –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –ë–∞—Ä—Å—ã –≤ —Å–≤–æ—é –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É, —É–∫–∞–∑–∞–≤ –∏—Ö —Ä–æ–ª—å. –ü–æ—Ç–æ–º –±—É–¥–µ—à—å –≤—ã–±–∏—Ä–∞—Ç—å –∏—Ö –∏–∑ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –≤–Ω–µ—Å–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.
      </p>
      <form id="playerForm">
        <div class="form-row">
          <div class="form-group">
            <label for="playerName">–ò–º—è –∏–≥—Ä–æ–∫–∞</label>
            <input type="text" id="playerName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–∞—Ñ–∏–Ω—å—è" required />
          </div>
          <div class="form-group" style="flex:0 0 150px;">
            <label for="playerRole">–†–æ–ª—å</label>
            <select id="playerRole">
              <option value="forward">–ù–∞–ø–∞–¥–∞—é—â–∏–π</option>
              <option value="midfield">–ü–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫</option>
              <option value="defender">–ó–∞—â–∏—Ç–Ω–∏–∫</option>
            </select>
          </div>
          <div class="form-group" style="flex:0 0 auto; align-self:flex-end;">
            <button type="submit">–î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
          </div>
        </div>
      </form>
      <div class="soft-divider"></div>
      <div class="players-list" id="playersList"></div>
      <div class="status" id="playerStatus"></div>
    </div>

    <!-- –°–µ–∑–æ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          üìä –°–µ–∑–æ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
          <span class="card-pill">–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö</span>
        </div>
      </div>
      <p class="card-description">
        –í–Ω–æ—Å–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ —Å–µ–∑–æ–Ω –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞. –°–µ–∑–æ–Ω—ã –Ω—É–º–µ—Ä—É—é—Ç—Å—è –æ—Ç 1 –¥–æ 15.
      </p>
      <form id="statsForm">
        <div class="form-row">
          <div class="form-group" style="flex:0 0 80px;">
            <label for="season">–°–µ–∑–æ–Ω</label>
            <select id="season"></select>
          </div>
          <div class="form-group">
            <label for="statsPlayer">–ò–≥—Ä–æ–∫</label>
            <select id="statsPlayer"></select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="matches">–ú–∞—Ç—á–∏</label>
            <input type="number" id="matches" min="0" step="1" placeholder="0" />
          </div>
          <div class="form-group">
            <label for="goals">–ì–æ–ª—ã</label>
            <input type="number" id="goals" min="0" step="1" placeholder="0" />
          </div>
          <div class="form-group">
            <label for="assists">–ì–æ–ª–µ–≤—ã–µ –ø–µ—Ä–µ–¥–∞—á–∏</label>
            <input type="number" id="assists" min="0" step="1" placeholder="0" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="rating">–û—Ü–µ–Ω–∫–∞ –∑–∞ —Å–µ–∑–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, 7.5)</label>
            <input type="number" id="rating" min="0" max="10" step="0.1" placeholder="0.0" />
          </div>
          <div class="form-group" style="flex:0 0 auto; align-self:flex-end;">
            <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
          </div>
        </div>
      </form>
      <div class="status" id="statsStatus"></div>
      <p style="margin-top:6px; font-size:0.75rem; color:var(--text-muted);">
        –ü–æ–¥—Å–∫–∞–∑–∫–∞: –µ—Å–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–ª—è —Ç–æ–≥–æ –∂–µ –∏–≥—Ä–æ–∫–∞ –∏ —Å–µ–∑–æ–Ω–∞, –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å—É–º–º–∏—Ä–æ–≤–∞—Ç—å—Å—è.
      </p>
    </div>

    <!-- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
          <span class="card-pill">–≠–∫—Å–ø–æ—Ä—Ç / –∏–º–ø–æ—Ä—Ç</span>
        </div>
      </div>
      <p class="card-description">
        –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª –ø–µ—Ä–µ–¥ —á–∏—Å—Ç–∫–æ–π –±—Ä–∞—É–∑–µ—Ä–∞ –∏–ª–∏ –ø–µ—Ä–µ–µ–∑–¥–æ–º –Ω–∞ –¥—Ä—É–≥–æ–π –ü–ö. –ü–æ—Ç–æ–º –º–æ–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –≤–µ—Ä–Ω—É—Ç—å –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.
      </p>
      <div class="form-row" style="flex-wrap:wrap; gap:8px;">
        <button type="button" id="exportBtn">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <label class="file-input">
          ‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å:
          <input type="file" id="importFile" accept="application/json,.json" />
        </label>
      </div>
      <p style="margin-top:6px; font-size:0.75rem; color:var(--text-muted);">
        –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞: <code>barca_stats_backup.json</code>. –ò–º–ø–æ—Ä—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ç–µ–∫—É—â–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.
      </p>
    </div>
  </section>

  <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
  <section class="section-grid">
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–µ–∑–æ–Ω–∞–º -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          üìÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–µ–∑–æ–Ω–∞–º
          <span class="card-pill">–ú–∞—Ç—á–∏ ¬∑ –ì–æ–ª—ã ¬∑ –ì+–ü ¬∑ –û—Ü–µ–Ω–∫–∞ ¬∑ –ò–º–ø–∞–∫—Ç</span>
        </div>
      </div>
      <p class="card-description">
        –ò–º–ø–∞–∫—Ç –¥–µ–ª–∏—Ç—Å—è –Ω–∞ <b>–∑–∞ –∏–≥—Ä—É</b> –∏ <b>–∑–∞ —Å–µ–∑–æ–Ω</b>. –ó–∞ —Å–µ–∑–æ–Ω —É—á–∏—Ç—ã–≤–∞–µ—Ç –æ–±—ä—ë–º –º–∞—Ç—á–µ–π, –Ω–æ –Ω–µ –ª–∏–Ω–µ–π–Ω–æ. –ù–∞–∂–∏–º–∞–π –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–æ–ª–±—Ü–∞, —á—Ç–æ–±—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å.
      </p>
      <div class="filters-row">
        <div class="form-group" style="margin-bottom:0; max-width:160px;">
          <label for="seasonFilter">–°–µ–∑–æ–Ω</label>
          <select id="seasonFilter"></select>
        </div>
        <span class="badge">–ö–ª–∏–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É = —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</span>
      </div>
      <div class="table-wrapper" id="seasonTableWrapper">
        <div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –î–æ–±–∞–≤—å –∏–≥—Ä–æ–∫–æ–≤ –∏ –≤–Ω–µ—Å–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–µ–∑–æ–Ω–∞.</div>
      </div>
    </div>

    <!-- –°—É–º–º–∞—Ä–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">
          üèÜ –°—É–º–º–∞ –∑–∞ –≤—Å–µ —Å–µ–∑–æ–Ω—ã
          <span class="card-pill">–¢–æ—Ç–∞–ª—ã –∏ –∫–∞—Ä—å–µ—Ä–∞</span>
        </div>
      </div>
      <p class="card-description">
        –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏–≥—Ä–æ–∫–∞–º –∑–∞ –≤—Å–µ —Å–µ–∑–æ–Ω—ã, –≤–∫–ª—é—á–∞—è –∫–∞—Ä—å–µ—Ä–Ω—ã–π –∏–º–ø–∞–∫—Ç (—Å—É–º–º–∞ —Å–µ–∑–æ–Ω–Ω—ã—Ö –∏–º–ø–∞–∫—Ç–æ–≤).
      </p>
      <div class="pill-group">
        <div class="pill">Œ£ –ú–∞—Ç—á–∏</div>
        <div class="pill">Œ£ –ì–æ–ª—ã</div>
        <div class="pill">Œ£ –ì–æ–ª–µ–≤—ã–µ</div>
        <div class="pill">Œ£ –ì+–ü</div>
        <div class="pill">–ì–æ–ª—ã / –∏–≥—Ä—É</div>
        <div class="pill">–ì+–ü / –∏–≥—Ä—É</div>
        <div class="pill">–ö–∞—Ä—å–µ—Ä–Ω—ã–π –∏–º–ø–∞–∫—Ç</div>
      </div>
      <div class="table-wrapper" id="totalTableWrapper">
        <div class="empty-state">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ —Å—É–º–º–∞—Ä–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</div>
      </div>
    </div>

    <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–µ–∑–æ–Ω–∞ + –∫–æ–º–∞–Ω–¥–∞ —Å–µ–∑–æ–Ω–∞ -->
    <div class="card" id="seasonInsightsCard" style="grid-column: 1 / -1;">
      <div class="card-header">
        <div class="card-title">
          üéØ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–µ–∑–æ–Ω–∞ –∏ –∫–æ–º–∞–Ω–¥–∞
          <span class="card-pill">–ù–∞–≥—Ä–∞–¥—ã ¬∑ –ü—Ä–æ—Ñ–∏–ª–∏ ¬∑ 4‚Äì2‚Äì4</span>
        </div>
      </div>
      <p class="card-description" id="seasonInsightsTitle">
        –í—ã–±–µ—Ä–∏ —Å–µ–∑–æ–Ω –≤ —Ñ–∏–ª—å—Ç—Ä–µ ‚Äú–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–µ–∑–æ–Ω–∞–º‚Äù –≤—ã—à–µ ‚Äî –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –Ω–∞–≥—Ä–∞–¥—ã, –ø—Ä–æ—Ñ–∏–ª–∏ –∏–≥—Ä–æ–∫–æ–≤ –∏ –∫–æ–º–∞–Ω–¥–∞ —Å–µ–∑–æ–Ω–∞.
      </p>
      <div id="seasonInsightsContent" class="season-insights">
        <!-- –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
      </div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ -->
    <div class="card" style="grid-column: 1 / -1;">
      <div class="card-header">
        <div class="card-title">
          üìà –ì—Ä–∞—Ñ–∏–∫ –∏–≥—Ä–æ–∫–∞ –ø–æ —Å–µ–∑–æ–Ω–∞–º
          <span class="card-pill">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π</span>
        </div>
      </div>
      <p class="card-description">
        –í—ã–±–µ—Ä–∏ –∏–≥—Ä–æ–∫–∞ –∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å (–≤–∫–ª—é—á–∞—è –∏–º–ø–∞–∫—Ç / –∏–≥—Ä—É –∏ –∑–∞ —Å–µ–∑–æ–Ω), —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ —Å–µ–∑–æ–Ω–∞–º.
      </p>
      <div class="filters-row">
        <div class="form-group" style="min-width:160px;">
          <label for="chartPlayer">–ò–≥—Ä–æ–∫</label>
          <select id="chartPlayer"></select>
        </div>
        <div class="form-group" style="min-width:190px;">
          <label for="chartMetric">–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</label>
          <select id="chartMetric">
            <option value="goals">–ì–æ–ª—ã</option>
            <option value="assists">–ì–æ–ª–µ–≤—ã–µ –ø–µ—Ä–µ–¥–∞—á–∏</option>
            <option value="ga">–ì–æ–ª + –ø–∞—Å</option>
            <option value="matches">–ú–∞—Ç—á–∏</option>
            <option value="rating">–û—Ü–µ–Ω–∫–∞</option>
            <option value="impactPg">–ò–º–ø–∞–∫—Ç / –∏–≥—Ä—É</option>
            <option value="impactSeason">–ò–º–ø–∞–∫—Ç –∑–∞ —Å–µ–∑–æ–Ω</option>
          </select>
        </div>
        <div class="form-group" style="flex:0 0 auto; align-self:flex-end;">
          <button type="button" id="showChartBtn">–ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="playerChartCanvas"></canvas>
      </div>
      <div id="chartMessage">–í—ã–±–µ—Ä–∏ –∏–≥—Ä–æ–∫–∞ –∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏ ¬´–ü–æ–∫–∞–∑–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫¬ª.</div>
    </div>
  </section>
</main>

<script>
  const STORAGE_KEYS = {
    players: "fc26_players",
    stats: "fc26_stats",
  };

  const ROLE_TYPES = {
    FORWARD: "forward",
    MIDFIELD: "midfield",
    DEFENDER: "defender",
  };

  const ROLE_LABELS_SHORT = {
    forward: "–ù–ê–ü",
    midfield: "–ü–ó",
    defender: "–ó–ê–©",
  };

  const ROLE_LABELS_FULL = {
    forward: "–ù–∞–ø–∞–¥–∞—é—â–∏–π",
    midfield: "–ü–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫",
    defender: "–ó–∞—â–∏—Ç–Ω–∏–∫",
  };

  // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø–æ —Ä–æ–ª—è–º (—Å –æ—Å–ª–∞–±–ª–µ–Ω–Ω—ã–º –∫—ç—Ñ–æ–º –∑–∞—â–∏—Ç–Ω–∏–∫—É)
  const ROLE_COEFFICIENTS = {
    forward:   { goals: 1, assists: 1,   rating: 1   },
    midfield:  { goals: 3, assists: 2,   rating: 1.1 },
    defender:  { goals: 4, assists: 2,   rating: 1.15 },
  };

  let players = [];
  let stats = [];

  const sortState = {
    seasonTable: { key: "seasonImpact", direction: "desc" },
    totalTable: { key: "careerImpact", direction: "desc" },
  };

  let playerChart = null;

  function loadFromStorage() {
    try {
      const playersRaw = localStorage.getItem(STORAGE_KEYS.players);
      const statsRaw = localStorage.getItem(STORAGE_KEYS.stats);
      players = playersRaw ? JSON.parse(playersRaw) : [];
      stats = statsRaw ? JSON.parse(statsRaw) : [];
    } catch (e) {
      console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∏–∑ localStorage", e);
      players = [];
      stats = [];
    }
  }

  function savePlayers() {
    localStorage.setItem(STORAGE_KEYS.players, JSON.stringify(players));
  }

  function saveStats() {
    localStorage.setItem(STORAGE_KEYS.stats, JSON.stringify(stats));
  }

  function createId() {
    return Date.now().toString(36) + Math.random().toString(36).substring(2, 8);
  }

  function getPlayerById(id) {
    return players.find((p) => p.id === id);
  }

  function getPlayerMap() {
    const map = new Map();
    players.forEach((p) => map.set(p.id, p));
    return map;
  }

  function numberOrZero(value) {
    const n = parseFloat(value);
    return isNaN(n) ? 0 : n;
  }

  function getInitials(name) {
    const parts = name.split(" ").filter(Boolean);
    if (!parts.length) return "?";
    if (parts.length === 1) {
      return parts[0][0].toUpperCase();
    }
    return (parts[0][0] + parts[1][0]).toUpperCase();
  }

  function getLastName(name) {
    const parts = name.trim().split(" ").filter(Boolean);
    if (!parts.length) return name;
    return parts[parts.length - 1];
  }

  function getPlayerRole(player) {
    if (!player || !player.role) return ROLE_TYPES.FORWARD;
    if (!ROLE_COEFFICIENTS[player.role]) return ROLE_TYPES.FORWARD;
    return player.role;
  }

  function computeMetricRanges(rows, metricKeys) {
    const ranges = {};
    metricKeys.forEach((key) => {
      let min = Infinity;
      let max = -Infinity;
      rows.forEach((r) => {
        const v = Number(r[key]);
        if (isNaN(v)) return;
        if (v < min) min = v;
        if (v > max) max = v;
      });
      if (min === Infinity) {
        min = 0;
        max = 0;
      }
      ranges[key] = { min, max };
    });
    return ranges;
  }

  function getMetricClass(key, value, ranges) {
    const range = ranges[key];
    if (!range) return "";
    const min = range.min;
    const max = range.max;
    const v = Number(value);
    if (isNaN(v) || max === min) return "";
    const norm = (v - min) / (max - min);
    if (norm < 0.33) return "metric-low";
    if (norm < 0.67) return "metric-mid";
    return "metric-high";
  }

  function exportData() {
    const data = {
      players,
      stats,
      exportedAt: new Date().toISOString(),
      version: "1.3",
    };
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "barca_stats_backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function importDataFromFile(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const data = JSON.parse(e.target.result);
        if (!data || !Array.isArray(data.players) || !Array.isArray(data.stats)) {
          alert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–∞–π–ª –±—ç–∫–∞–ø–∞: –Ω–µ—Ç players –∏–ª–∏ stats.");
          return;
        }
        if (!confirm("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—É—â—É—é –±–∞–∑—É?")) {
          return;
        }
        players = data.players;
        stats = data.stats;
        savePlayers();
        saveStats();
        renderPlayers();
        renderSeasonTable();
        renderTotalTable();
        renderSeasonInsights();
        if (playerChart) {
          playerChart.destroy();
          playerChart = null;
        }
        document.getElementById("chartMessage").textContent =
          "–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã. –í—ã–±–µ—Ä–∏ –∏–≥—Ä–æ–∫–∞ –∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞.";
        alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!");
      } catch (err) {
        console.error(err);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ –±—ç–∫–∞–ø–∞. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—ã–±—Ä–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π JSON.");
      }
    };
    reader.readAsText(file, "utf-8");
  }

  function deletePlayer(playerId) {
    const player = getPlayerById(playerId);
    const name = player ? player.name : "–∏–≥—Ä–æ–∫–∞";

    if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${name} –∏ –í–°–Æ –µ–≥–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –≤—Å–µ —Å–µ–∑–æ–Ω—ã?`)) {
      return;
    }

    players = players.filter((p) => p.id !== playerId);
    stats = stats.filter((s) => s.playerId !== playerId);
    savePlayers();
    saveStats();

    renderPlayers();
    renderSeasonTable();
    renderTotalTable();
    renderSeasonInsights();

    const chartPlayerSelect = document.getElementById("chartPlayer");
    if (chartPlayerSelect && chartPlayerSelect.value === playerId) {
      chartPlayerSelect.value = "";
      if (playerChart) {
        playerChart.destroy();
        playerChart = null;
      }
      const msg = document.getElementById("chartMessage");
      msg.textContent = "–ò–≥—Ä–æ–∫ —É–¥–∞–ª—ë–Ω. –í—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞.";
    }
  }

  function deleteSeasonStats(playerId, season) {
    const player = getPlayerById(playerId);
    const name = player ? player.name : "–∏–≥—Ä–æ–∫";
    if (
      !confirm(
        `–£–¥–∞–ª–∏—Ç—å –í–°–Æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–≥—Ä–æ–∫–∞ ${name} –∑–∞ —Å–µ–∑–æ–Ω ${season}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`
      )
    ) {
      return;
    }

    stats = stats.filter(
      (s) => !(s.playerId === playerId && s.season === season)
    );
    saveStats();
    renderSeasonTable();
    renderTotalTable();
    renderSeasonInsights();

    const chartPlayerSelect = document.getElementById("chartPlayer");
    if (chartPlayerSelect && chartPlayerSelect.value === playerId) {
      showChart();
    }
  }

  function populateSeasonSelects() {
    const seasonSelect = document.getElementById("season");
    const seasonFilter = document.getElementById("seasonFilter");

    seasonSelect.innerHTML = "";
    seasonFilter.innerHTML = "";

    for (let i = 1; i <= 15; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = i;
      seasonSelect.appendChild(opt);
    }

    const allOpt = document.createElement("option");
    allOpt.value = "all";
    allOpt.textContent = "–í—Å–µ —Å–µ–∑–æ–Ω—ã";
    seasonFilter.appendChild(allOpt);

    for (let i = 1; i <= 15; i++) {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = "–°–µ–∑–æ–Ω " + i;
      seasonFilter.appendChild(opt);
    }

    seasonFilter.value = "all";
  }

  function renderPlayers() {
    const playersList = document.getElementById("playersList");
    const statsPlayerSelect = document.getElementById("statsPlayer");
    const chartPlayerSelect = document.getElementById("chartPlayer");

    playersList.innerHTML = "";
    statsPlayerSelect.innerHTML = "";
    chartPlayerSelect.innerHTML = "";

    if (!players.length) {
      const placeholder = document.createElement("div");
      placeholder.className = "empty-state";
      placeholder.textContent = "–î–æ–±–∞–≤—å –∏–≥—Ä–æ–∫–æ–≤, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å.";
      playersList.appendChild(placeholder);

      const noneOpt = document.createElement("option");
      noneOpt.value = "";
      noneOpt.textContent = "–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å –∏–≥—Ä–æ–∫–æ–≤";
      statsPlayerSelect.appendChild(noneOpt);

      const noneOpt2 = document.createElement("option");
      noneOpt2.value = "";
      noneOpt2.textContent = "–ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤";
      chartPlayerSelect.appendChild(noneOpt2);
      return;
    }

    players
      .slice()
      .sort((a, b) => a.name.localeCompare(b.name, "ru"))
      .forEach((p) => {
        const chip = document.createElement("div");
        chip.className = "player-chip";
        chip.dataset.playerId = p.id;

        const initials = document.createElement("div");
        initials.className = "player-initials";
        initials.textContent = getInitials(p.name);

        const roleSpan = document.createElement("span");
        const roleKey = getPlayerRole(p);
        roleSpan.className = "badge";
        roleSpan.textContent = ROLE_LABELS_SHORT[roleKey] || "–†–û–õ–¨";

        const span = document.createElement("span");
        span.textContent = p.name;

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.textContent = "‚úï";
        removeBtn.className = "button-secondary";
        removeBtn.style.padding = "0 6px";
        removeBtn.style.fontSize = "0.75rem";
        removeBtn.style.lineHeight = "1.2";
        removeBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          deletePlayer(p.id);
        });

        chip.appendChild(initials);
        chip.appendChild(roleSpan);
        chip.appendChild(span);
        chip.appendChild(removeBtn);
        playersList.appendChild(chip);

        const opt1 = document.createElement("option");
        opt1.value = p.id;
        opt1.textContent = p.name;
        statsPlayerSelect.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = p.id;
        opt2.textContent = p.name;
        chartPlayerSelect.appendChild(opt2);
      });
  }

  function renderSeasonTable() {
    const wrapper = document.getElementById("seasonTableWrapper");
    wrapper.innerHTML = "";

    if (!stats.length) {
      const empty = document.createElement("div");
      empty.className = "empty-state";
      empty.textContent =
        "–ù–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏. –î–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–∞–ø–∏—Å—å —Å–µ–∑–æ–Ω–∞.";
      wrapper.appendChild(empty);
      return;
    }

    const seasonFilter = document.getElementById("seasonFilter").value;
    const playerMap = getPlayerMap();

    let rows = stats.map((s) => {
      const player = playerMap.get(s.playerId);
      const goals = numberOrZero(s.goals);
      const assists = numberOrZero(s.assists);
      const matches = numberOrZero(s.matches);
      const rating = numberOrZero(s.rating);
      const ga = goals + assists;
      const gpg = matches > 0 ? goals / matches : 0;
      const apg = matches > 0 ? assists / matches : 0;
      const gapg = matches > 0 ? ga / matches : 0;

      const roleKey = getPlayerRole(player);
      const coeff = ROLE_COEFFICIENTS[roleKey] || ROLE_COEFFICIENTS.forward;

      const impactPerGame =
        gpg * coeff.goals +
        apg * coeff.assists +
        rating * coeff.rating;

      return {
        season: s.season,
        playerId: s.playerId,
        playerName: player ? player.name : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
        roleKey,
        roleLabel: ROLE_LABELS_SHORT[roleKey] || "",
        matches,
        goals,
        assists,
        ga,
        goalsPerGame: gpg,
        assistsPerGame: apg,
        gaPerGame: gapg,
        rating,
        impactPerGameRaw: impactPerGame,
        impactPerGame: 0,
        seasonImpact: 0,
      };
    });

    if (seasonFilter !== "all") {
      const seasonNum = parseInt(seasonFilter, 10);
      rows = rows.filter((r) => r.season === seasonNum);
    }

    if (!rows.length) {
      const empty = document.createElement("div");
      empty.className = "empty-state";
      empty.textContent = "–î–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–µ–∑–æ–Ω–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç.";
      wrapper.appendChild(empty);
      return;
    }

    let maxMatches = 0;
    rows.forEach((r) => {
      if (r.matches > maxMatches) maxMatches = r.matches;
    });
    if (maxMatches <= 0) maxMatches = 1;

    rows.forEach((r) => {
      r.impactPerGame = r.impactPerGameRaw;
      const factor = 0.5 + 0.5 * (r.matches / maxMatches);
      r.seasonImpact = r.impactPerGame * factor;
    });

    const { key, direction } = sortState.seasonTable;
    rows.sort((a, b) =>
      compareValues(
        a[key],
        b[key],
        key === "playerName" || key === "roleLabel",
        direction
      )
    );

    const metricKeys = [
      "matches",
      "goals",
      "assists",
      "ga",
      "goalsPerGame",
      "assistsPerGame",
      "gaPerGame",
      "rating",
      "impactPerGame",
      "seasonImpact",
    ];
    const ranges = computeMetricRanges(rows, metricKeys);

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const tbody = document.createElement("tbody");

    const headers = [
      { key: "season", label: "–°–µ–∑–æ–Ω", numeric: true, sortable: true, metric: false },
      { key: "playerName", label: "–ò–≥—Ä–æ–∫", numeric: false, sortable: true, metric: false },
      { key: "roleLabel", label: "–†–æ–ª—å", numeric: false, sortable: true, metric: false },
      { key: "matches", label: "–ú–∞—Ç—á–∏", numeric: true, sortable: true, metric: true },
      { key: "goals", label: "–ì–æ–ª—ã", numeric: true, sortable: true, metric: true },
      { key: "assists", label: "–ü–∞—Å—ã", numeric: true, sortable: true, metric: true },
      { key: "ga", label: "–ì+–ü", numeric: true, sortable: true, metric: true },
      { key: "goalsPerGame", label: "–ì–æ–ª—ã / –∏–≥—Ä—É", numeric: true, sortable: true, metric: true, format: "fixed2" },
      { key: "assistsPerGame", label: "–ü–∞—Å—ã / –∏–≥—Ä—É", numeric: true, sortable: true, metric: true, format: "fixed2" },
      { key: "gaPerGame", label: "–ì+–ü / –∏–≥—Ä—É", numeric: true, sortable: true, metric: true, format: "fixed2" },
      { key: "rating", label: "–û—Ü–µ–Ω–∫–∞", numeric: true, sortable: true, metric: true, format: "fixed2" },
      { key: "impactPerGame", label: "–ò–º–ø–∞–∫—Ç / –∏–≥—Ä—É", numeric: true, sortable: true, metric: true, format: "fixed2" },
      { key: "seasonImpact", label: "–ò–º–ø–∞–∫—Ç —Å–µ–∑–æ–Ω", numeric: true, sortable: true, metric: true, format: "fixed2" },
      { key: "actions", label: "", numeric: false, sortable: false, metric: false },
    ];

    const trHead = document.createElement("tr");
    headers.forEach((h) => {
      const th = document.createElement("th");
      th.textContent = h.label;
      th.dataset.key = h.key;
      th.dataset.numeric = h.numeric ? "1" : "0";

      if (h.sortable !== false) {
        th.classList.add("sortable");
        if (sortState.seasonTable.key === h.key) {
          th.classList.add(
            sortState.seasonTable.direction === "asc"
              ? "sort-asc"
              : "sort-desc"
          );
        }
        th.addEventListener("click", () => {
          updateSort("seasonTable", h.key);
          renderSeasonTable();
          renderSeasonInsights();
        });
      }

      trHead.appendChild(th);
    });
    thead.appendChild(trHead);

    rows.forEach((row) => {
      const tr = document.createElement("tr");

      headers.forEach((h) => {
        if (h.key === "actions") {
          const tdDelete = document.createElement("td");
          tdDelete.style.textAlign = "center";
          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.textContent = "‚úï";
          deleteBtn.title = "–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —ç—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –∑–∞ —ç—Ç–æ—Ç —Å–µ–∑–æ–Ω";
          deleteBtn.className = "button-secondary";
          deleteBtn.style.padding = "2px 8px";
          deleteBtn.style.fontSize = "0.75rem";
          deleteBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            deleteSeasonStats(row.playerId, row.season);
          });
          tdDelete.appendChild(deleteBtn);
          tr.appendChild(tdDelete);
          return;
        }

        const td = document.createElement("td");
        let value = row[h.key];

        if (h.format === "fixed2") {
          value = Number(value).toFixed(2);
        }

        if (h.key === "playerName") {
          td.style.textAlign = "left";
        }

        if (h.metric) {
          const cls = getMetricClass(h.key, row[h.key], ranges);
          if (cls) td.classList.add(cls);
        }

        td.textContent = value;
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });

    table.appendChild(thead);
    table.appendChild(tbody);
    wrapper.appendChild(table);

    // –æ–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –±–ª–æ–∫
    renderSeasonInsights(rows);
  }

  function renderTotalTable() {
    const wrapper = document.getElementById("totalTableWrapper");
    wrapper.innerHTML = "";

    if (!stats.length) {
      const empty = document.createElement("div");
      empty.className = "empty-state";
      empty.textContent =
        "–ù–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏. –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–∞–ø–∏—Å—å —Å–µ–∑–æ–Ω–∞.";
      wrapper.appendChild(empty);
      return;
    }

    const totals = {};
    const playerMap = getPlayerMap();

    // —Å–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å —Å–µ–∑–æ–Ω–Ω—ã–µ –∏–º–ø–∞–∫—Ç—ã –¥–ª—è CareerImpact
    const tmpRowsForImpact = buildSeasonRowsForAll();

    const seasonImpactMap = {};
    tmpRowsForImpact.forEach((r) => {
      if (!seasonImpactMap[r.playerId]) seasonImpactMap[r.playerId] = 0;
      seasonImpactMap[r.playerId] += r.seasonImpact;
    });

    stats.forEach((s) => {
      const playerId = s.playerId;
      if (!totals[playerId]) {
        const player = playerMap.get(playerId);
        totals[playerId] = {
          playerId,
          playerName: player ? player.name : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
          matches: 0,
          goals: 0,
          assists: 0,
          ga: 0,
          careerImpact: seasonImpactMap[playerId] || 0,
        };
      }
      const t = totals[playerId];
      const matches = numberOrZero(s.matches);
      const goals = numberOrZero(s.goals);
      const assists = numberOrZero(s.assists);
      t.matches += matches;
      t.goals += goals;
      t.assists += assists;
      t.ga += goals + assists;
    });

    let rows = Object.values(totals).map((t) => {
      const gpg = t.matches > 0 ? t.goals / t.matches : 0;
      const apg = t.matches > 0 ? t.assists / t.matches : 0;
      const gapg = t.matches > 0 ? t.ga / t.matches : 0;
      return {
        ...t,
        goalsPerGame: gpg,
        assistsPerGame: apg,
        gaPerGame: gapg,
      };
    });

    const { key, direction } = sortState.totalTable;
    rows.sort((a, b) =>
      compareValues(a[key], b[key], key === "playerName", direction)
    );

    const metricKeys = [
      "matches",
      "goals",
      "assists",
      "ga",
      "goalsPerGame",
      "assistsPerGame",
      "gaPerGame",
      "careerImpact",
    ];
    const ranges = computeMetricRanges(rows, metricKeys);

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const tbody = document.createElement("tbody");

    const headers = [
      { key: "playerName", label: "–ò–≥—Ä–æ–∫", numeric: false, metric: false },
      { key: "matches", label: "–ú–∞—Ç—á–∏", numeric: true, metric: true },
      { key: "goals", label: "–ì–æ–ª—ã", numeric: true, metric: true },
      { key: "assists", label: "–ü–∞—Å—ã", numeric: true, metric: true },
      { key: "ga", label: "–ì+–ü", numeric: true, metric: true },
      { key: "goalsPerGame", label: "–ì–æ–ª—ã / –∏–≥—Ä—É", numeric: true, metric: true, format: "fixed2" },
      { key: "assistsPerGame", label: "–ü–∞—Å—ã / –∏–≥—Ä—É", numeric: true, metric: true, format: "fixed2" },
      { key: "gaPerGame", label: "–ì+–ü / –∏–≥—Ä—É", numeric: true, metric: true, format: "fixed2" },
      { key: "careerImpact", label: "–ö–∞—Ä—å–µ—Ä–Ω—ã–π –∏–º–ø–∞–∫—Ç", numeric: true, metric: true, format: "fixed2" },
    ];

    const trHead = document.createElement("tr");
    headers.forEach((h) => {
      const th = document.createElement("th");
      th.textContent = h.label;
      th.dataset.key = h.key;
      th.dataset.numeric = h.numeric ? "1" : "0";
      th.classList.add("sortable");
      if (sortState.totalTable.key === h.key) {
        th.classList.add(
          sortState.totalTable.direction === "asc" ? "sort-asc" : "sort-desc"
        );
      }
      th.addEventListener("click", () => {
        updateSort("totalTable", h.key);
        renderTotalTable();
      });
      trHead.appendChild(th);
    });
    thead.appendChild(trHead);

    rows.forEach((row) => {
      const tr = document.createElement("tr");
      headers.forEach((h) => {
        const td = document.createElement("td");
        let value = row[h.key];

        if (h.format === "fixed2") {
          value = Number(value).toFixed(2);
        }

        if (h.key === "playerName") {
          td.style.textAlign = "left";
        }

        if (h.metric) {
          const cls = getMetricClass(h.key, row[h.key], ranges);
          if (cls) td.classList.add(cls);
        }

        td.textContent = value;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    table.appendChild(thead);
    table.appendChild(tbody);
    wrapper.appendChild(table);
  }

  function compareValues(a, b, isString, direction) {
    let res;
    if (isString) {
      res = String(a).localeCompare(String(b), "ru");
    } else {
      const na = Number(a);
      const nb = Number(b);
      res = na === nb ? 0 : na < nb ? -1 : 1;
    }
    return direction === "asc" ? res : -res;
  }

  function updateSort(tableName, key) {
    const sort = sortState[tableName];
    if (sort.key === key) {
      sort.direction = sort.direction === "asc" ? "desc" : "asc";
    } else {
      sort.key = key;
      sort.direction = key === "playerName" ? "asc" : "desc";
    }
  }

  // –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ–∑–æ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –ø–æ –≤—Å–µ–º —Å–µ–∑–æ–Ω–∞–º (–¥–ª—è –∫–∞—Ä—å–µ—Ä–Ω–æ–≥–æ –∏–º–ø–∞–∫—Ç–∞)
  function buildSeasonRowsForAll() {
    if (!stats.length) return [];
    const playerMap = getPlayerMap();

    const rows = stats.map((s) => {
      const player = playerMap.get(s.playerId);
      const goals = numberOrZero(s.goals);
      const assists = numberOrZero(s.assists);
      const matches = numberOrZero(s.matches);
      const rating = numberOrZero(s.rating);
      const ga = goals + assists;
      const gpg = matches > 0 ? goals / matches : 0;
      const apg = matches > 0 ? assists / matches : 0;

      const roleKey = getPlayerRole(player);
      const coeff = ROLE_COEFFICIENTS[roleKey] || ROLE_COEFFICIENTS.forward;

      const impactPerGame =
        gpg * coeff.goals +
        apg * coeff.assists +
        rating * coeff.rating;

      return {
        season: s.season,
        playerId: s.playerId,
        matches,
        goals,
        assists,
        ga,
        impactPerGameRaw: impactPerGame,
      };
    });

    // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ–∑–æ–Ω–∞ –Ω—É–∂–µ–Ω —Å–≤–æ–π maxMatches
    const maxMatchesBySeason = {};
    rows.forEach((r) => {
      const s = r.season;
      if (!maxMatchesBySeason[s] || r.matches > maxMatchesBySeason[s]) {
        maxMatchesBySeason[s] = r.matches;
      }
    });

    rows.forEach((r) => {
      const maxMatches = maxMatchesBySeason[r.season] || 1;
      const factor = 0.5 + 0.5 * (r.matches / maxMatches);
      r.impactPerGame = r.impactPerGameRaw;
      r.seasonImpact = r.impactPerGame * factor;
    });

    return rows;
  }

  // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–µ–∑–æ–Ω–∞: –Ω–∞–≥—Ä–∞–¥—ã, –ø—Ä–æ—Ñ–∏–ª–∏, –∫–æ–º–∞–Ω–¥–∞ —Å–µ–∑–æ–Ω–∞
  function renderSeasonInsights(prebuiltRows) {
    const titleEl = document.getElementById("seasonInsightsTitle");
    const contentEl = document.getElementById("seasonInsightsContent");
    contentEl.innerHTML = "";

    if (!stats.length || !players.length) {
      titleEl.textContent =
        "–î–æ–±–∞–≤—å –∏–≥—Ä–æ–∫–æ–≤ –∏ —Å–µ–∑–æ–Ω–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É ‚Äî –∑–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –Ω–∞–≥—Ä–∞–¥—ã –∏ –∫–æ–º–∞–Ω–¥–∞ —Å–µ–∑–æ–Ω–∞.";
      return;
    }

    const seasonFilter = document.getElementById("seasonFilter").value;
    let seasonToUse;

    if (seasonFilter === "all") {
      const seasons = [...new Set(stats.map((s) => s.season))];
      if (!seasons.length) {
        titleEl.textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–µ–∑–æ–Ω–∞.";
        return;
      }
      seasonToUse = Math.max(...seasons);
    } else {
      seasonToUse = parseInt(seasonFilter, 10);
    }

    titleEl.textContent = `–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Å–µ–∑–æ–Ω—É ${seasonToUse}. –§–∏–ª—å—Ç—Ä –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –≤—ã—à–µ.`;

    const playerMap = getPlayerMap();

    let rows;
    if (prebuiltRows) {
      rows = prebuiltRows.filter((r) => r.season === seasonToUse);
    } else {
      const allRows = buildSeasonRowsForAll();
      rows = allRows.filter((r) => r.season === seasonToUse).map((r) => {
        const player = playerMap.get(r.playerId);
        const roleKey = getPlayerRole(player);
        return {
          ...r,
          playerName: player ? player.name : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
          roleKey,
          roleLabel: ROLE_LABELS_SHORT[roleKey] || "",
        };
      });
    }

    if (!rows.length) {
      contentEl.innerHTML = "<div class='empty-state'>–ó–∞ —ç—Ç–æ—Ç —Å–µ–∑–æ–Ω –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.</div>";
      return;
    }

    // –û–±–æ–≥–æ—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –∏–º–µ–Ω–µ–º –∏ —Ä–æ–ª—å—é (–µ—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –Ω–µ–≥–æ—Ç–æ–≤—ã–µ)
    if (!rows[0].playerName) {
      rows = rows.map((r) => {
        const player = playerMap.get(r.playerId);
        const roleKey = getPlayerRole(player);
        const goals = r.goals ?? numberOrZero(0);
        const assists = r.assists ?? numberOrZero(0);
        const matches = r.matches ?? numberOrZero(0);
        const ga = goals + assists;
        const gpg = matches > 0 ? goals / matches : 0;
        const apg = matches > 0 ? assists / matches : 0;
        const coeff = ROLE_COEFFICIENTS[roleKey] || ROLE_COEFFICIENTS.forward;
        const rating = numberOrZero(r.rating);
        const impactPerGame =
          gpg * coeff.goals +
          apg * coeff.assists +
          rating * coeff.rating;
        return {
          ...r,
          playerName: player ? player.name : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ",
          roleKey,
          roleLabel: ROLE_LABELS_SHORT[roleKey] || "",
          ga,
          goalsPerGame: gpg,
          assistsPerGame: apg,
          impactPerGame: impactPerGame || r.impactPerGame,
        };
      });
    }

    // –ü–µ—Ä–µ—Å—á—ë—Ç maxMatches –∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ seasonImpact –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
    let maxMatches = 0;
    rows.forEach((r) => {
      if (r.matches > maxMatches) maxMatches = r.matches;
    });
    if (maxMatches <= 0) maxMatches = 1;
    rows.forEach((r) => {
      const factor = 0.5 + 0.5 * (r.matches / maxMatches);
      if (typeof r.impactPerGame === "undefined") r.impactPerGame = r.impactPerGameRaw || 0;
      r.seasonImpact = r.impactPerGame * factor;
    });

    // --- –ù–∞–≥—Ä–∞–¥—ã —Å–µ–∑–æ–Ω–∞ (3.8) ---
    function getMaxByKey(key) {
      let best = null;
      rows.forEach((r) => {
        const v = Number(r[key]) || 0;
        if (v <= 0) return;
        if (!best || v > best.value) {
          best = { row: r, value: v };
        }
      });
      return best;
    }

    const bestGoals = getMaxByKey("goals");
    const bestAssists = getMaxByKey("assists");
    const bestGA = getMaxByKey("ga");
    const bestImpactPg = getMaxByKey("impactPerGame");
    const bestImpactSeason = getMaxByKey("seasonImpact");

    // --- –ü—Ä–æ—Ñ–∏–ª–∏ (1.5: –∫–∞—á–µ—Å—Ç–≤–æ vs –æ–±—ä—ë–º) ---
    const impactPgValues = rows.map((r) => r.impactPerGame);
    const seasonImpactValues = rows.map((r) => r.seasonImpact);

    function median(arr) {
      const valid = arr.map(Number).filter((v) => !isNaN(v));
      if (!valid.length) return 0;
      valid.sort((a, b) => a - b);
      const mid = Math.floor(valid.length / 2);
      if (valid.length % 2 === 0) {
        return (valid[mid - 1] + valid[mid]) / 2;
      }
      return valid[mid];
    }

    const medianImpactPg = median(impactPgValues);
    const medianSeasonImpact = median(seasonImpactValues);

    const profileBuckets = {
      alien: [],
      sniper: [],
      horse: [],
      rotation: [],
    };

    rows.forEach((r) => {
      const highQuality = r.impactPerGame >= medianImpactPg;
      const highVolume = r.seasonImpact >= medianSeasonImpact;

      let type;
      if (highQuality && highVolume) type = "alien";
      else if (highQuality && !highVolume) type = "sniper";
      else if (!highQuality && highVolume) type = "horse";
      else type = "rotation";

      profileBuckets[type].push(r);
    });

    // --- –ö–æ–º–∞–Ω–¥–∞ —Å–µ–∑–æ–Ω–∞ 4‚Äì2‚Äì4 ---
    const defenders = rows
      .filter((r) => r.roleKey === ROLE_TYPES.DEFENDER)
      .sort((a, b) => b.seasonImpact - a.seasonImpact)
      .slice(0, 4);

    const midfielders = rows
      .filter((r) => r.roleKey === ROLE_TYPES.MIDFIELD)
      .sort((a, b) => b.seasonImpact - a.seasonImpact)
      .slice(0, 2);

    const forwards = rows
      .filter((r) => r.roleKey === ROLE_TYPES.FORWARD)
      .sort((a, b) => b.seasonImpact - a.seasonImpact)
      .slice(0, 4);

    // --- –†–µ–Ω–¥–µ—Ä ---
    const awardsBlock = document.createElement("div");
    awardsBlock.className = "season-insights-left";

    const awardsList = document.createElement("div");
    awardsList.className = "awards-list";

    function awardLine(label, best, metricLabel) {
      if (!best) return;
      const div = document.createElement("div");
      div.className = "award-item";
      const spanLabel = document.createElement("span");
      spanLabel.textContent = label + ":";
      const spanValue = document.createElement("span");
      spanValue.innerHTML = `<b>${best.row.playerName}</b> ‚Äî ${best.value.toFixed ? best.value.toFixed(2) : best.value} ${metricLabel}`;
      div.appendChild(spanLabel);
      div.appendChild(spanValue);
      awardsList.appendChild(div);
    }

    awardLine("ü•á –ë–æ–º–±–∞—Ä–¥–∏—Ä", bestGoals, "–≥–æ–ª–æ–≤");
    awardLine("üéØ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç", bestAssists, "–ø–∞—Å–æ–≤");
    awardLine("‚ö° –ì+–ü", bestGA, "–ì+–ü");
    awardLine("üî• –ò–º–ø–∞–∫—Ç / –∏–≥—Ä—É", bestImpactPg, "–æ—á–∫–∏");
    awardLine("üëë –ò–º–ø–∞–∫—Ç –∑–∞ —Å–µ–∑–æ–Ω", bestImpactSeason, "–æ—á–∫–∏");

    const profilesTitle = document.createElement("div");
    profilesTitle.style.marginTop = "8px";
    profilesTitle.style.fontSize = "0.78rem";
    profilesTitle.style.color = "var(--text-muted)";
    profilesTitle.textContent = "–ü—Ä–æ—Ñ–∏–ª–∏ –∏–≥—Ä–æ–∫–æ–≤ (–∫–∞—á–µ—Å—Ç–≤–æ vs –æ–±—ä—ë–º):";

    const profilesGrid = document.createElement("div");
    profilesGrid.className = "profiles-grid";

    function profileBlock(title, key, cssClass) {
      const block = document.createElement("div");
      block.className = "profile-block";
      const t = document.createElement("div");
      t.className = "profile-title";
      t.textContent = title;
      const list = document.createElement("div");
      list.className = "profile-list";

      profileBuckets[key].forEach((r) => {
        const tag = document.createElement("div");
        tag.className = "profile-tag " + cssClass;
        tag.textContent = getLastName(r.playerName);
        list.appendChild(tag);
      });

      if (!profileBuckets[key].length) {
        const tag = document.createElement("div");
        tag.className = "profile-tag";
        tag.textContent = "‚Äî";
        list.appendChild(tag);
      }

      block.appendChild(t);
      block.appendChild(list);
      profilesGrid.appendChild(block);
    }

    profileBlock("ALIEN ¬∑ —Ç–æ–ø –∏ –ø–æ –∫–∞—á–µ—Å—Ç–≤—É, –∏ –ø–æ –æ–±—ä—ë–º—É", "alien", "alien");
    profileBlock("SNIPER ¬∑ –º–æ–Ω—Å—Ç—Ä –ø–æ –∫–∞—á–µ—Å—Ç–≤—É, –º–∞–ª–æ –º–∞—Ç—á–µ–π", "sniper", "sniper");
    profileBlock("HORSE ¬∑ —Ç–∞—â–∏—Ç –æ–±—ä—ë–º–æ–º", "horse", "horse");
    profileBlock("ROTATION ¬∑ —Ä–æ—Ç–∞—Ü–∏—è / –≥–ª—É–±–∏–Ω–∞", "rotation", "rotation");

    awardsBlock.appendChild(awardsList);
    awardsBlock.appendChild(profilesTitle);
    awardsBlock.appendChild(profilesGrid);

    const pitchBlock = document.createElement("div");
    pitchBlock.className = "pitch-wrapper";

    const pitch = document.createElement("div");
    pitch.className = "pitch";

    function line(playersLine, roleLabel) {
      const lineDiv = document.createElement("div");
      lineDiv.className = "pitch-line";
      playersLine.forEach((r) => {
        const div = document.createElement("div");
        div.className = "pitch-player";
        const nameSpan = document.createElement("span");
        nameSpan.textContent = getLastName(r.playerName);
        const roleSpan = document.createElement("span");
        roleSpan.className = "pitch-player-role";
        roleSpan.textContent = roleLabel;
        div.appendChild(nameSpan);
        div.appendChild(roleSpan);
        lineDiv.appendChild(div);
      });
      return lineDiv;
    }

    const defendersLine = line(defenders, "–ó–ê–©");
    const midsLine = line(midfielders, "–ü–ó");
    const forwardsLine = line(forwards, "–ù–ê–ü");

    // –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ 4‚Äì2‚Äì4: –∑–∞—â–∏—Ç–∞, —Ü–µ–Ω—Ç—Ä, –∞—Ç–∞–∫–∞ (–Ω–µ—Ç –≤—Ä–∞—Ç–∞—Ä—è, –º—ã –ø—Ä–æ –ø–æ–ª–µ–≤—ã—Ö)
    pitch.appendChild(defendersLine);
    pitch.appendChild(midsLine);
    pitch.appendChild(forwardsLine);

    const pitchCaption = document.createElement("div");
    pitchCaption.className = "pitch-caption";
    pitchCaption.textContent =
      "–ö–æ–º–∞–Ω–¥–∞ —Å–µ–∑–æ–Ω–∞ 4‚Äì2‚Äì4 –ø–æ –∏–º–ø–∞–∫—Ç—É –∑–∞ —Å–µ–∑–æ–Ω. –ï—Å–ª–∏ –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ –º–µ–Ω—å—à–µ –∏–≥—Ä–æ–∫–æ–≤, –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ.";

    pitchBlock.appendChild(pitch);
    pitchBlock.appendChild(pitchCaption);

    contentEl.appendChild(awardsBlock);
    contentEl.appendChild(pitchBlock);
  }

  function showChart() {
    const playerId = document.getElementById("chartPlayer").value;
    const metric = document.getElementById("chartMetric").value;
    const messageEl = document.getElementById("chartMessage");

    if (!playerId) {
      messageEl.textContent =
        "–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å –∏–≥—Ä–æ–∫–æ–≤ –∏ –≤—ã–±–µ—Ä–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞.";
      return;
    }

    const player = getPlayerById(playerId);
    if (!player) {
      messageEl.textContent = "–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ.";
      return;
    }

    const playerStats = stats.filter((s) => s.playerId === playerId);
    if (!playerStats.length) {
      messageEl.textContent = "–î–ª—è —ç—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –ø–æ–∫–∞ –Ω–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.";
      if (playerChart) {
        playerChart.destroy();
        playerChart = null;
      }
      return;
    }

    const seasonsMap = {};
    playerStats.forEach((s) => {
      const season = s.season;
      if (!seasonsMap[season]) {
        seasonsMap[season] = {
          matches: 0,
          goals: 0,
          assists: 0,
          ga: 0,
          ratingSum: 0,
          ratingCount: 0,
        };
      }
      const m = seasonsMap[season];
      const matches = numberOrZero(s.matches);
      const goals = numberOrZero(s.goals);
      const assists = numberOrZero(s.assists);
      const rating = numberOrZero(s.rating);

      m.matches += matches;
      m.goals += goals;
      m.assists += assists;
      m.ga += goals + assists;
      if (!isNaN(rating) && rating > 0) {
        m.ratingSum += rating;
        m.ratingCount += 1;
      }
    });

    const seasons = Object.keys(seasonsMap)
      .map((s) => parseInt(s, 10))
      .sort((a, b) => a - b);

    let maxMatches = 0;
    seasons.forEach((s) => {
      const m = seasonsMap[s];
      if (m.matches > maxMatches) maxMatches = m.matches;
    });
    if (maxMatches <= 0) maxMatches = 1;

    const labels = seasons.map((s) => "–°–µ–∑–æ–Ω " + s);
    const roleKey = getPlayerRole(player);
    const coeff = ROLE_COEFFICIENTS[roleKey] || ROLE_COEFFICIENTS.forward;

    const data = seasons.map((s) => {
      const m = seasonsMap[s];
      const matches = m.matches;
      const goals = m.goals;
      const assists = m.assists;
      const ga = m.ga;
      const avgRating = m.ratingCount ? m.ratingSum / m.ratingCount : 0;
      const gpg = matches > 0 ? goals / matches : 0;
      const apg = matches > 0 ? assists / matches : 0;

      const impactPg =
        gpg * coeff.goals +
        apg * coeff.assists +
        avgRating * coeff.rating;

      switch (metric) {
        case "matches":
          return matches;
        case "goals":
          return goals;
        case "assists":
          return assists;
        case "ga":
          return ga;
        case "rating":
          return avgRating;
        case "impactPg":
          return impactPg;
        case "impactSeason": {
          const factor = 0.5 + 0.5 * (matches / maxMatches);
          return impactPg * factor;
        }
        default:
          return 0;
      }
    });

    const metricNameMap = {
      goals: "–ì–æ–ª—ã",
      assists: "–ì–æ–ª–µ–≤—ã–µ –ø–µ—Ä–µ–¥–∞—á–∏",
      ga: "–ì–æ–ª + –ø–∞—Å",
      matches: "–ú–∞—Ç—á–∏",
      rating: "–û—Ü–µ–Ω–∫–∞",
      impactPg: "–ò–º–ø–∞–∫—Ç / –∏–≥—Ä—É",
      impactSeason: "–ò–º–ø–∞–∫—Ç –∑–∞ —Å–µ–∑–æ–Ω",
    };

    const ctx = document.getElementById("playerChartCanvas").getContext("2d");
    if (playerChart) {
      playerChart.destroy();
    }

    playerChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: `${player.name}: ${metricNameMap[metric]}`,
            data,
            tension: 0.25,
            fill: true,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: { color: "#cbd5f5", font: { size: 11 } },
            grid: { display: false },
          },
          y: {
            beginAtZero: true,
            ticks: { color: "#cbd5f5", font: { size: 11 } },
            grid: { color: "rgba(148, 163, 184, 0.2)" },
          },
        },
        plugins: {
          legend: {
            labels: { color: "#e5e7eb", font: { size: 11 } },
          },
          tooltip: {
            callbacks: {
              label: function (ctx) {
                const v = ctx.parsed.y;
                return `${v} ‚Äî ${metricNameMap[metric]}`;
              },
            },
          },
        },
      },
    });

    messageEl.textContent = `–ì—Ä–∞—Ñ–∏–∫ –¥–ª—è –∏–≥—Ä–æ–∫–∞ ${player.name} –ø–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—é ¬´${metricNameMap[metric]}¬ª.`;
  }

  function initForms() {
    const playerForm = document.getElementById("playerForm");
    const statsForm = document.getElementById("statsForm");
    const playerStatus = document.getElementById("playerStatus");
    const statsStatus = document.getElementById("statsStatus");
    const exportBtn = document.getElementById("exportBtn");
    const importFileInput = document.getElementById("importFile");

    playerForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const nameInput = document.getElementById("playerName");
      const roleSelect = document.getElementById("playerRole");
      const name = nameInput.value.trim();
      const role = roleSelect.value || ROLE_TYPES.FORWARD;

      if (!name) {
        playerStatus.textContent = "–ò–º—è –∏–≥—Ä–æ–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.";
        playerStatus.className = "status error";
        return;
      }
      const exists = players.some(
        (p) => p.name.toLowerCase() === name.toLowerCase()
      );
      if (exists) {
        playerStatus.textContent =
          "–ò–≥—Ä–æ–∫ —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ –µ—Å—Ç—å –≤ –±–∞–∑–µ.";
        playerStatus.className = "status error";
        return;
      }
      const newPlayer = { id: createId(), name, role };
      players.push(newPlayer);
      savePlayers();
      renderPlayers();
      renderSeasonInsights();
      nameInput.value = "";
      roleSelect.value = ROLE_TYPES.FORWARD;
      playerStatus.textContent = "–ò–≥—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É.";
      playerStatus.className = "status success";
    });

    statsForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const season = parseInt(document.getElementById("season").value, 10);
      const playerId = document.getElementById("statsPlayer").value;
      const matches = numberOrZero(document.getElementById("matches").value);
      const goals = numberOrZero(document.getElementById("goals").value);
      const assists = numberOrZero(document.getElementById("assists").value);
      const rating = numberOrZero(document.getElementById("rating").value);

      if (!playerId) {
        statsStatus.textContent = "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∏–≥—Ä–æ–∫–∞.";
        statsStatus.className = "status error";
        return;
      }

      if (
        isNaN(season) ||
        (matches === 0 && goals === 0 && assists === 0 && rating === 0)
      ) {
        statsStatus.textContent =
          "–ó–∞–ø–æ–ª–Ω–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —á–∏—Å–ª–æ–≤–æ–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å (–º–∞—Ç—á–∏, –≥–æ–ª—ã, –ø–∞—Å—ã –∏–ª–∏ –æ—Ü–µ–Ω–∫–∞).";
        statsStatus.className = "status error";
        return;
      }

      const entry = {
        id: createId(),
        season,
        playerId,
        matches,
        goals,
        assists,
        rating,
      };
      stats.push(entry);
      saveStats();

      renderSeasonTable();
      renderTotalTable();
      statsStatus.textContent = "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ–∑–æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.";
      statsStatus.className = "status success";
    });

    document
      .getElementById("seasonFilter")
      .addEventListener("change", () => {
        renderSeasonTable();
        renderSeasonInsights();
      });

    document
      .getElementById("showChartBtn")
      .addEventListener("click", showChart);

    if (exportBtn) {
      exportBtn.addEventListener("click", exportData);
    }

    if (importFileInput) {
      importFileInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        importDataFromFile(file);
        e.target.value = "";
      });
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadFromStorage();
    populateSeasonSelects();
    renderPlayers();
    renderSeasonTable();
    renderTotalTable();
    renderSeasonInsights();
    initForms();
  });
</script>
</body>
</html>
